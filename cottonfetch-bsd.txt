#!/bin/env bash

# WARNING!! this script is heavily experimental! it is NOT guaranteed to work!

show_help() {
    echo
    echo -e "\e[1mcottonfetch 1.10.3\e[0m"
    echo "created by servalx4"
    echo -e "\e[3m\"all hail the holy cult of cotton!!\"\e[0m"
# sometimes, i wonder if farcotton still remembers this program
    echo
    echo "usage:"
    echo "  cottonfetch             show system info"
    echo "  cottonfetch -ns         show system info, no shortening"
    echo "  cottonfetch --help      show this message"
    echo
    echo "thank you for using cottonfetch <3"
    echo
    echo "special thanks:"
    echo "  hikari (discord) — font fixes"
    echo "  immaculatekatz (github) — distro detection help"
    echo
}

# flags

[[ $* == *--help* ]] && show_help && exit 0

no_shorten=false
for arg in "$@"; do
    [[ $arg == "-ns" || $arg == "--no-shorten" ]] && no_shorten=true
done

# colors
declare -A C=(
    [nc]='\e[0m' [blk]='\e[0;30m' [dgr]='\e[1;30m'
    [red]='\e[0;31m' [lrd]='\e[1;31m'
    [grn]='\e[0;32m' [lgr]='\e[1;32m'
    [ylw]='\e[1;33m' [org]='\e[0;33m'
    [blu]='\e[0;34m' [lbl]='\e[1;34m'
    [prp]='\e[0;35m' [lpr]='\e[1;35m'
    [cyn]='\e[0;36m' [lcy]='\e[1;36m'
    [wht]='\e[1;37m' [lgy]='\e[0;37m'
)
blink='\033[5m' # thanks, pancoreon!

# gather basics
kernelname=$(uname -s)
kernel=$(uname -r)
architecture=$(uname -m)
hostname=$(hostname)
os=$(uname -o)
user=$(whoami)

[[ -z $XDG_SESSION_TYPE ]] && XDG_SESSION_TYPE='unknown'
[[ -z $XDG_CURRENT_DESKTOP ]] && XDG_CURRENT_DESKTOP='unknown'

# distro detection
if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    distro=$NAME
elif command -v lsb_release &>/dev/null; then
    distro=$(lsb_release -si)
elif [[ -f /etc/lsb-release ]]; then
    . /etc/lsb-release
    distro=$DISTRIB_ID
else
    distro=$kernelname
fi

# kernel shorten
if ! $no_shorten && [[ ${#kernel} -gt 15 ]]; then
    kernel="${kernel:0:15}..."
fi

# memory
if command -v sysctl &>/dev/null; then
    mem_total=$(( $(sysctl -n hw.physmem) / 1024 / 1024 ))
    mem_free=$(( $(sysctl -n vm.stats.vm.v_free_count) * $(sysctl -n hw.pagesize) / 1024 / 1024 ))
    mem_used=$((mem_total - mem_free))
    swap_total=$(swapinfo -k | awk 'NR==2 {print $2/1024}')
    swap_used=$(swapinfo -k | awk 'NR==2 {print ($2-$3)/1024}')
else
    mem_total=unknown
    mem_free=unknown
    mem_used=unknown
    swap_total=unknown
    swap_used=unknown
fi

# disk
read disk_total disk_used <<<$(df -k / | awk 'NR==2 {printf "%.1fGB %.1fGB", $2/1024/1024, $3/1024/1024}')
filesystem="$(df -T / | tail -1 | awk '{print $2; exit}')"

# cpu
cpu=$(sysctl -n hw.model 2>/dev/null || echo "unknown")

# gpu
if command -v glxinfo &>/dev/null; then
    gpu=$(glxinfo 2>/dev/null | awk -F: '/Device/ {print $2; exit}' | xargs)
else
    gpu=$(lspci 2>/dev/null | awk -F: '/VGA/ {print $3; exit}' | xargs)
fi
[[ -z $gpu ]] && gpu="unknown"

if ! $no_shorten && [[ ${#gpu} -gt 40 ]]; then
    gpu="${gpu:0:40}..."
fi

# uptime
uptime=$(uptime -p | cut -d' ' -f2-)

# resolution detection
if command -v xrandr &>/dev/null; then
    res=$(xrandr | awk '/ connected/{print $4; exit}' | cut -d+ -f1)
fi

if [[ -z $res ]]; then
    if command -v wlr-randr &>/dev/null; then
        res=$(wlr-randr | awk '/\*/{print $1; exit}')
    elif command -v swaymsg &>/dev/null; then
        res=$(swaymsg -t get_outputs | grep -oP '"width":\K\d+|"height":\K\d+' | paste -sdx)
    fi
fi
if [[ -z $res ]]; then
    for card in /sys/class/drm/*-*/; do
        [[ -f "$card/status" && $(<"$card/status") == "connected" ]] && res=$(head -n1 "$card/modes")
    done
fi
[[ -z $res ]] && res="unknown"

# package count (slow)
get_pkg_count() {
    if command -v pkg &>/dev/null; then
        pkg info | wc -l | sed 's/^[[:space:]]*//'
    elif command -v brew &>/dev/null; then
        brew list | wc -l
    else
        echo "unknown"
    fi
}
pkgs=$(get_pkg_count)

# distro colors/icons
case $distro in
    'FreeBSD') dcol=${C[red]} acol=${C[lrd]} icon='' ;;
    'OpenBSD') dcol=${C[ylw]} acol=${C[lgy]} icon='' ;;
    *) dcol=${C[lgy]} acol=${C[wht]} icon='?' ;;
esac

# ascii logo, feel free to change
ascii=(
"⠀⠀⠀⠀⠀⠠⠀⠄⢀⠀⠂⠀⠐⠀⠄⠀⠀⠀⠀⠀"
"⠀⠀⠀⡐⠈⠀⡀⠠⠠⠁⠄⠀⡐⢀⢈⠢⠀⠀⠀⠀"
"⠀⠀⠀⢄⡑⠠⡀⠢⢈⠆⡨⢐⠄⠃⠂⠃⠠⠀⠀⠀"
"⠀⠠⢁⠀⢀⠀⠁⠣⣪⣮⡢⠃⡀⠀⠐⢀⠐⡑⠀⠀"
"⠀⢂⢆⠠⠂⠠⡈⠂⠈⠁⠉⠢⡠⡈⠄⢂⠄⠬⠀⠀"
"⠀⠀⠨⡌⢕⢕⠀⠂⢀⠂⠠⠀⠨⡢⡕⡑⣕⣅⠀⠀"
"⠀⠀⡼⣙⢞⢧⡑⢕⠔⣅⢢⡑⢌⡾⡹⣚⠕⢮⠆⠀"
"⠀⠀⠻⣬⡪⣎⠯⠛⢸⠀⡷⣝⢏⢎⢎⢦⡛⡼⠃⠀"
"⠀⠀⠀⠀⠀⠀⠀⠀⠈⡆⡇⠈⠓⠙⠊⠊⠉⠀⠀⠀"
"⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀" # i'd advise you make every line have the same length, unless you know what you're doing
)
empty="⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀" # and make sure this variable is as wide as the ascii logo as well
sep='>' # separator, feel free to change

# info, feel free to change
#
# available options:
#
# ${dcol} - distro colour
# ${acol} - accent colour
# ${blink} - blinking text
# ${C[nc]} - reset colour/blink
# ${icon} - distro icon
# ${sep} - separator
#
# ${hostname}
# ${user}
# ${kernel}
# ${kernelname}
# ${os}
# ${pkgs}
#
# ${mem_used}
# ${mem_total
# ${swap_used}
# ${swap_total}
# ${cpu}
# ${gpu}
# ${disk_used}
# ${disk_total}
# ${filesystem}
# ${architecture}
# ${uptime}
#
# ${res}
# ${XDG_CURRENT_DESKTOP} - current desktop environment/window manager
# ${XDG_SESSION_TYPE} - display server, hopefully
info=(
'echo'
'echo -e "${dcol}${user}${C[nc]}@${acol}${hostname}"'
'echo -e "╭ ${acol}os${C[nc]}"'
'echo -e "type ${sep} ${dcol}${icon} ${distro}${C[nc]}"'
'echo -e "krnl ${sep} ${dcol}${os} ${C[nc]}${kernel}${C[nc]}"'
'echo -e "arch ${sep} ${dcol}${architecture}${C[nc]}"'
'echo -e "pkgs ${sep} ${dcol}${pkgs}${C[nc]}"'
'echo'
'echo -e "╭ ${acol}pc${C[nc]}"'
'echo -e "ram ${sep} ${dcol}${mem_used}/${mem_total}MB,${C[nc]} ${swap_used}/${swap_total}MB swap"'
'echo -e "cpu ${sep} ${dcol}${cpu}"${C[nc]}'
'echo -e "gpu ${sep} ${dcol}${gpu}"${C[nc]}'
'echo -e "dsk ${sep} ${dcol}${disk_used}/${disk_total},"${C[nc]} ${filesystem}'
'echo'
'echo -e "╭ ${acol}display${C[nc]}"${C[nc]}'
'echo -e "res    ${sep} ${dcol}${res}"${C[nc]}'
'echo -e "de/wm  ${sep} ${dcol}${XDG_CURRENT_DESKTOP}"${C[nc]}'
'echo -e "server ${sep} ${dcol}${XDG_SESSION_TYPE}"${C[nc]}'
'echo'
)

# don't modify this!
asciilen="${#ascii[@]}"
infolen="${#info[@]}"

diff=$(( asciilen - infolen ))
(( diff < 0 )) && diff=0

for (( i = 0; i < asciilen + 1 || i < infolen; i++ )); do
    if (( i == 0 )); then
        echo -en "$empty"
    elif (( i - 1 < asciilen )); then
        echo -en "${dcol}${ascii[i-1]}${C[nc]}"
    else
        echo -en "$empty"
    fi

    if (( i >= asciilen && diff > 0 )); then
        for (( j = 0; j < diff; j++ )); do
            echo -en "$empty"
        done
    fi

    if (( i < infolen )); then
        eval "${info[i]}"
    else
        echo ""
    fi
done

# Fish support
#                           .
#                           A       ;
#                 |   ,--,-/ \---,-/|  ,
#                _|\,'. /|      /|   `/|-.
#            \`.'    /|      ,            `;.
#           ,'\   A     A         A   A _ /| `.;
#         ,/  _              A       _  / _   /|  ;
#        /\  / \   ,  ,           A  /    /     `/|
#       /_| | _ \         ,     ,             ,/  \
#      // | |/ `.\  ,-      ,       ,   ,/ ,/      \/
#      / @| |@  / /'   \  \      ,              >  /|    ,--.
#     |\_/   \_/ /      |  |           ,  ,/        \  ./' __:..
#     |  __ __  |       |  | .--.  ,         >  >   |-'   /     `
#   ,/| /  '  \ |       |  |     \      ,           |    /
#  /  |<--.__,->|       |  | .    `.        >  >    /   (
# /_,' \\  ^  /  \     /  /   `.    >--            /^\   |
#       \\___/    \   /  /      \__'     \   \   \/   \  |
#        `.   |/          ,  ,                  /`\    \  )
#          \  '  |/    ,       V    \          /        `-\
#           `|/  '  V      V           \    \.'            \_
#            '`-.       V       V        \./'\
#                `|/-.      \ /   \ /,---`\         kat
#                 /   `._____V_____V'
#                            '     '
